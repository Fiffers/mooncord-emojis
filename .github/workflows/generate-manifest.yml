name: Generate Emoji Pack Manifest

on:
  push:
    branches:
      - main
    paths:
      - '**.png'
      - '**.jpg'
      - '**.jpeg'
      - '**.gif'
  workflow_dispatch:

env:
  PACK_NAME: "mooncord-emojis"
  PACK_VERSION: "1.0.0"
  PACK_AUTHOR: "Fiffers"
  PACK_DESCRIPTION: "Mooncord emoji pack for RuneLite Custom Emoji plugin"

jobs:
  generate-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Generate pack.json manifest
        run: |
          echo "Generating manifest for pack: $PACK_NAME"

          # Find all image files and generate emoji entries
          EMOJIS="["
          FIRST=true

          while IFS= read -r -d '' file; do
            # Skip if no files found
            [ -z "$file" ] && continue

            # Get relative path from repo root
            REL_PATH="${file#./}"

            # Skip files in .github directory
            [[ "$REL_PATH" == .github/* ]] && continue

            # Get filename without path
            FILENAME=$(basename "$file")

            # Compute SHA-256 hash
            SHA=$(sha256sum "$file" | cut -d' ' -f1)

            # Add comma separator if not first entry
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              EMOJIS="$EMOJIS,"
            fi

            # Add emoji entry
            EMOJIS="$EMOJIS
              {
                \"name\": \"$FILENAME\",
                \"path\": \"$REL_PATH\",
                \"sha\": \"$SHA\"
              }"

            echo "  Added: $REL_PATH ($SHA)"
          done < <(find . -type f \( -iname "*.png" -o -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.gif" \) -print0 | sort -z)

          EMOJIS="$EMOJIS
            ]"

          # Generate the manifest JSON
          cat > pack.json << EOF
          {
            "name": "$PACK_NAME",
            "version": "$PACK_VERSION",
            "author": "$PACK_AUTHOR",
            "description": "$PACK_DESCRIPTION",
            "emojis": $EMOJIS
          }
          EOF

          # Pretty print the JSON (if jq is available)
          if command -v jq &> /dev/null; then
            jq '.' pack.json > pack.json.tmp && mv pack.json.tmp pack.json
          fi

          echo "Manifest generated successfully"
          echo "Total emojis: $(jq '.emojis | length' pack.json)"

      - name: Commit manifest
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Check if pack.json exists and changed, or is new
          if [ ! -f pack.json ]; then
            echo "No pack.json generated"
            exit 0
          fi

          git add pack.json

          if git diff --cached --quiet; then
            echo "No changes to manifest"
          else
            git commit -m "Update pack.json manifest [skip ci]"
            git push origin main
            echo "Manifest committed and pushed to main branch"
          fi
